(window.webpackJsonp=window.webpackJsonp||[]).push([[366],{1208:function(e,t,n){"use strict";n(1140);var a=n(0),i=n.n(a),o=n(1174);t.a=function(e){var t=e.children,n=e.name;return i.a.createElement(o.a,{type:"info",fill:!0,icon:!1,rounded:!0,className:"list--icons list--icons--arrow list--tight list--indent margin-bottom--lg"},i.a.createElement("p",{class:"text--lg margin-bottom--sm",style:{marginTop:"-0.25em"}},"Before you begin, this ",n||"page"," assumes the following:"),t)}},520:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return s})),n.d(t,"metadata",(function(){return l})),n.d(t,"rightToc",(function(){return c})),n.d(t,"default",(function(){return m}));var a=n(1),i=(n(0),n(1130)),o=n(1174),r=n(1208);const s={last_modified_on:"2020-04-22",$schema:"/.meta/.schemas/guides.json",title:"Managing Schemas in Vector",description:"Learn how to manage log schemas with Vector.",author_github:"https://github.com/hoverbear",tags:["type: guide"]},l={categories:[{name:"advanced",title:"Advanced",description:"Go beyond the basics, become a Vector pro, and extract the full potential of Vector.",permalink:"/guides/advanced"}],coverLabel:"Managing Schemas in Vector",description:"Learn how to manage log schemas with Vector.",permalink:"/guides/advanced/schemas",readingTime:"8 min read",source:"@site/guides/advanced/schemas.md",tags:[{label:"type: guide",permalink:"/guides/tags/type-guide"}],title:"Managing Schemas in Vector",truncated:!1,prevItem:{title:"Custom Aggregations with Lua",permalink:"/guides/advanced/custom-aggregations-with-lua"},nextItem:{title:"Merge multi-line logs with Lua",permalink:"/guides/advanced/merge-multiline-logs-with-lua"}},c=[{value:"Overriding Global Field Names",id:"overriding-global-field-names",children:[{value:"Example: Custom timestamp field",id:"example-custom-timestamp-field",children:[]}]},{value:"Pipeline field filtering",id:"pipeline-field-filtering",children:[{value:"Example: Filtering data for GDPR compliance",id:"example-filtering-data-for-gdpr-compliance",children:[]}]},{value:"Sink field filtering",id:"sink-field-filtering",children:[{value:"Example: Per host kafka topics",id:"example-per-host-kafka-topics",children:[]}]},{value:"Moving and Concatenating Fields",id:"moving-and-concatenating-fields",children:[{value:"Example: Mooshing together name fields",id:"example-mooshing-together-name-fields",children:[]}]},{value:"Coercing Data Types",id:"coercing-data-types",children:[{value:"Example: Coercing into a specific format",id:"example-coercing-into-a-specific-format",children:[]}]},{value:"Working with data formats",id:"working-with-data-formats",children:[]},{value:"Parting thoughts",id:"parting-thoughts",children:[]}],p={rightToc:c};function m({components:e,...t}){return Object(i.b)("wrapper",Object(a.a)({},p,t,{components:e,mdxType:"MDXLayout"}),Object(i.b)(r.a,{name:"guide",mdxType:"Assumptions"},Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"You understand the ",Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"/docs/about/concepts/"}),"basic Vector concepts")," and understand ",Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"/guides/getting-started/your-first-pipeline/"}),"how to set up a pipeline"),"."))),Object(i.b)("p",null,"Data comes in all shapes and sizes. Vector has an array (let's call it a vector \ud83d\ude0e) of composable functionality for\ndecoding your events in the right format, transforming them into the right shape, and passing that data on downstream."),Object(i.b)("p",null,"While your first uses of Vector might be connecting ",Object(i.b)("inlineCode",{parentName:"p"},"stdin")," to ",Object(i.b)("inlineCode",{parentName:"p"},"honeycomb"),", eventually you're going to have other\nrequirements. Maybe regional laws prevent you from shipping certain data, or you need to do some data mudging to conform\nsome logs to the rest of your system. With a little configuration we can teach Vector to solve all these problems!"),Object(i.b)("h2",{id:"overriding-global-field-names"},"Overriding Global Field Names"),Object(i.b)("p",null,"By default, Vector primarily operates on three fields: ",Object(i.b)("inlineCode",{parentName:"p"},"host"),", ",Object(i.b)("inlineCode",{parentName:"p"},"message"),", and ",Object(i.b)("inlineCode",{parentName:"p"},"timestamp"),"."),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-json"}),'{\n  "host": "my.host.com",\n  "message": "some important content",\n  "timestamp": "2019-11-01T21:15:47+00:00"\n}\n')),Object(i.b)("p",null,"Vector sets these fields on logs as it ingests data (from a ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/reference/sources/"}),"source"),"). It may be that your data does not\nfollow this convention. In this case you can modify the global defaults for all incoming data in the ",Object(i.b)("inlineCode",{parentName:"p"},"log_schema"),"\nsection of your ",Object(i.b)("inlineCode",{parentName:"p"},"vector.toml"),"."),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-toml",metastring:'title="vector.toml"',title:'"vector.toml"'}),'[log_schema]\nhost_key = "instance" # default "host"\nmessage_key = "info" # default "message"\ntimestamp_key = "datetime" # default "timestamp"\n\n# Sources, transforms, and sinks...\n')),Object(i.b)(o.a,{type:"info",mdxType:"Alert"},Object(i.b)("p",null,"Not all sources use the ",Object(i.b)("inlineCode",{parentName:"p"},"host")," field.")),Object(i.b)("p",null,"We find this feature is useful when used with simple configs! As your number of components grows, your needs will change\nand you'll likely need to configure this at a more fine grained level."),Object(i.b)("h3",{id:"example-custom-timestamp-field"},"Example: Custom timestamp field"),Object(i.b)("p",null,"Some services will produce logs with the timestamp field mapped to ",Object(i.b)("inlineCode",{parentName:"p"},"@timestamp")," or some other value."),Object(i.b)("p",null,"If your vector pipeline is only working with data passing through these systems, you can add the following to your\n",Object(i.b)("inlineCode",{parentName:"p"},"vector.toml"),":"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-toml",metastring:'title="vector.toml"',title:'"vector.toml"'}),'[log_schema]\n  timestamp_key = "@timestamp"  # Applies to all sources, sinks, and transforms!\n\n[sources.my_naming_confused_source]\n  type = "logplex"\n  address = "0.0.0.0:8088"\n')),Object(i.b)("h2",{id:"pipeline-field-filtering"},"Pipeline field filtering"),Object(i.b)("p",null,"Sometimes it is advantageous to filter out specific fields during the pipeline. You can use a ",Object(i.b)("inlineCode",{parentName:"p"},"remove_fields")," transform\nto do this."),Object(i.b)("p",null,"Commonly you'll want to do this near either the source or sink of your pipeline. Some example use cases:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"Dropping ",Object(i.b)("inlineCode",{parentName:"li"},"email"),", ",Object(i.b)("inlineCode",{parentName:"li"},"passport_number"),", or other personally identifiable information from logs before distributing them\nto third party services."),Object(i.b)("li",{parentName:"ul"},"Filtering data for compliance with the GDPR or other regional laws. (eg EU to US dataflows)"),Object(i.b)("li",{parentName:"ul"},"Reducing the volume of data on a particular endpoint.")),Object(i.b)("p",null,"A transform of this type looks like this:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-toml",metastring:'title="vector.toml"',title:'"vector.toml"'}),'[transforms.strip_personal_details]\ntype = "remove_fields"\ninputs = ["my-source-id"]\nfields = ["email", "passport_number"]\n')),Object(i.b)("h3",{id:"example-filtering-data-for-gdpr-compliance"},"Example: Filtering data for GDPR compliance"),Object(i.b)("p",null,"Let's pretend we have a nice well behaved application piping Vector logs like the following:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-json"}),'{ "id": "user1", "gdpr": false, "email": "us-user1@timber.io" }\n{ "id": "user2", "gdpr": false, "email": "us-user2@timber.io" }\n{ "id": "user3", "gdpr": true, "email": "eu-user3@timber.io" }\n')),Object(i.b)("p",null,"In our theoretical product, we're expanding into the EU and want to comply with the GDPR. In our case, that means our\napplication can't send EU user data to our US based kafka. (We're not lawyers, this is not a magic GDPR-compliance\nconfig, just a little example!)"),Object(i.b)("p",null,"We can build a config that will do the first part of this, but we'll just output to console for ease of this example."),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-toml",metastring:'title="vector.toml"',title:'"vector.toml"'}),'data_dir = "./data"\ndns_servers = []\n\n[sources.application]\nmax_length = 102400\ntype = "stdin"\n\n[transforms.parse]\ninputs = ["application"]\ndrop_field = true\ndrop_invalid = false\ntype = "json_parser"\n\n[transforms.not_gdpr]\ntype = "filter"\ninputs = ["parse"]\ncondition.type = "check_fields"\ncondition."gdpr.eq" = "false"\n\n[transforms.gdpr_to_strip]\ntype = "filter"\ninputs = ["parse"]\ncondition.type = "check_fields"\ncondition."gdpr.eq" = "true"\n\n[transforms.gdpr_stripped]\ntype = "remove_fields"\ninputs = ["gdpr_to_strip"]\nfields = ["email"]\n\n[sinks.console]\nhealthcheck = true\ninputs = ["not_gdpr", "gdpr_stripped"]\ntype = "console"\nencoding = "json"\n[sinks.console.buffer]\ntype = "memory"\nmax_events = 500\nwhen_full = "block"\n')),Object(i.b)("p",null,"Let's have a look:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),'$ cat <<-EOF | cargo run -- --config test.toml\n{ "id": "user1", "gdpr": false, "email": "us-user1@timber.io" }\n{ "id": "user2", "gdpr": false, "email": "us-user2@timber.io" }\n{ "id": "user3", "gdpr": true, "email": "eu-user3@timber.io" }\nEOF\nFeb 05 16:13:59.241  INFO source{name=application type=stdin}: vector::sources::stdin: finished sending\n{"id":"user1","timestamp":"2020-02-06T00:13:59.241801798Z","host":"obsidian","email":"us-user1@timber.io","gdpr":false}\n{"gdpr":false,"host":"obsidian","email":"us-user2@timber.io","timestamp":"2020-02-06T00:13:59.241815255Z","id":"user2"}\n{"id":"user3","gdpr":true,"host":"obsidian","timestamp":"2020-02-06T00:13:59.241816010Z"}\nFeb 05 16:15:27.945  INFO vector: Shutting down.\n')),Object(i.b)("p",null,"Don't know where events are coming from? You can use the ",Object(i.b)("inlineCode",{parentName:"p"},"geoip")," transform an ",Object(i.b)("inlineCode",{parentName:"p"},"ipv4")," field and get a grip on that!"),Object(i.b)("h2",{id:"sink-field-filtering"},"Sink field filtering"),Object(i.b)("p",null,"While it's often reasonable to remove this kind of data at the pipeline level, we identified use cases that involve\nusing values in sinks from these fields in sink configuration."),Object(i.b)("p",null,"The applications for this include some of the reasons discussed in\n",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"#pipeline-field-filtering"}),'"Pipeline field filtering"'),", but also:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"Stripping off routing related fields"),Object(i.b)("li",{parentName:"ul"},"Ensuring a specific sink will only ever output specific fields (or never output certain fields)")),Object(i.b)("h3",{id:"example-per-host-kafka-topics"},"Example: Per host kafka topics"),Object(i.b)("p",null,"Lets take a look at what that might look like:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-toml",metastring:'title="vector.toml"',title:'"vector.toml"'}),'[sinks.output]\n  inputs = ["demo"]\n  type = "kafka"\n\n  # Put events in the host specific topic.\n  topic = "{{service}}"\n  encoding.except_fields = ["service"] # Remove this field now and save some bytes\n  # ...\n')),Object(i.b)(o.a,{type:"warning",mdxType:"Alert"},Object(i.b)("p",null,"Gotcha: Not all fields are templatable! Make sure to check the documentation and test before deploying. If you find\na field which you want templatable open an issue and let us know.")),Object(i.b)("h2",{id:"moving-and-concatenating-fields"},"Moving and Concatenating Fields"),Object(i.b)("p",null,"It's fairly common for one part of your pipeline to expect a field to be named differently than another part! Vector can\nslide data around for you with the ",Object(i.b)("inlineCode",{parentName:"p"},"rename_fields")," transform."),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-toml",metastring:'title="vector.toml"',title:'"vector.toml"'}),'[transforms.rename_timestamp]\n  type = "rename_fields"\n  inputs = ["source0"]\n  fields.timestamp = "@timestamp"\n')),Object(i.b)("p",null,"Other times, you need to concatenate two fields together. Vector has an\n",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/reference/transforms/add_fields/"}),Object(i.b)("inlineCode",{parentName:"a"},"add_fields"))," transform that you can use alongside the\n",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/reference/transforms/add_fields/"}),Object(i.b)("inlineCode",{parentName:"a"},"remove_fields"))," transform to do just that!"),Object(i.b)("p",null,"It's useful for when:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"You need to adapt or reshape data to fit into possibly older or newer systems."),Object(i.b)("li",{parentName:"ul"},"You need to concatenate ",Object(i.b)("inlineCode",{parentName:"li"},"first_name")," and ",Object(i.b)("inlineCode",{parentName:"li"},"last_name")," into a ",Object(i.b)("inlineCode",{parentName:"li"},"name")," field. (Suppose they didn't read\n",Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"https://www.kalzumeus.com/2010/06/17/falsehoods-programmers-believe-about-names/"}),"Falsehoods about names"),").")),Object(i.b)("h3",{id:"example-mooshing-together-name-fields"},"Example: Mooshing together name fields"),Object(i.b)("p",null,"Let's pretend one of your teammates falsely assumed folks always have first and last names, so we have a ",Object(i.b)("inlineCode",{parentName:"p"},"first_name"),"\nand a ",Object(i.b)("inlineCode",{parentName:"p"},"last_name")," field coming from a source, and we'd like to output a ",Object(i.b)("inlineCode",{parentName:"p"},"name")," field to a sink."),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-toml",metastring:'title="vector.toml"',title:'"vector.toml"'}),'[transforms.moosh_names]\n  type = "add_fields"\n  inputs = ["source0"]\n  fields.name = "{{first_name}} {{last_name}}"\n\n[transforms.drop_old_names]\n  type = "remove_fields"\n  inputs = ["moosh_names"]\n  fields = ["first_name", "last_name"]\n')),Object(i.b)(o.a,{type:"info",mdxType:"Alert"},Object(i.b)("p",null,"What if you had to do this in reverse? Try using the ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/reference/transforms/regex_parser/"}),Object(i.b)("inlineCode",{parentName:"a"},"regex_parser"))," or\n",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/reference/transforms/split/"}),Object(i.b)("inlineCode",{parentName:"a"},"split"))," transforms.")),Object(i.b)("h2",{id:"coercing-data-types"},"Coercing Data Types"),Object(i.b)("p",null,"Occasionally services will provide you with data that is in the right shape, but the types are wrong. Perhaps a string\nshould be a number, or vice versa."),Object(i.b)("p",null,"The ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/reference/transforms/coercer/"}),Object(i.b)("inlineCode",{parentName:"a"},"coercer"))," transform is the correct tool for this job!"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-toml",metastring:'title="vector.toml"',title:'"vector.toml"'}),'[transforms.correct_source_types]\n  type = "coercer"\n  inputs = ["source0"]\n  types.count = "int"\n  types.date = "timestamp|%F"\n')),Object(i.b)("p",null,"You can also use this transform as a lightweight schema by specifying ",Object(i.b)("inlineCode",{parentName:"p"},"drop_unspecified = true"),", empowering it to drop\nfields you've not specified."),Object(i.b)("p",null,"Adding ",Object(i.b)("inlineCode",{parentName:"p"},"drop_unspecified = true")," to the above would mean any log coming out of the ",Object(i.b)("inlineCode",{parentName:"p"},"correct_source_types")," would only\nhave a ",Object(i.b)("inlineCode",{parentName:"p"},"count")," and ",Object(i.b)("inlineCode",{parentName:"p"},"date")," field. Coercer? More like enforcer."),Object(i.b)("h3",{id:"example-coercing-into-a-specific-format"},"Example: Coercing into a specific format"),Object(i.b)("p",null,"There are a lot of ways to represent time. In the US folks tend to use ",Object(i.b)("inlineCode",{parentName:"p"},"MM/DD/YYYY")," or the (more reasonable)\n",Object(i.b)("inlineCode",{parentName:"p"},"YYYY/MM/DD")," which Canada and China like. In the EU, South America, and Africa they prefer ",Object(i.b)("inlineCode",{parentName:"p"},"DD/MM/YYYY"),". Like personal\nidentities, all are valid. Vector lets us take in timestamps and output specific formats easily."),Object(i.b)("p",null,"To do this we'll use ",Object(i.b)("inlineCode",{parentName:"p"},"timestamp| $FORMAT"),". To build a ",Object(i.b)("inlineCode",{parentName:"p"},"$FORMAT"),", we can reference the\n",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.rs/chrono/0.4.10/chrono/format/strftime/index.html"}),Object(i.b)("inlineCode",{parentName:"a"},"strftime"))," documentation. Let's ship some Canadian\nfriendly logs up to the great white north!"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-toml",metastring:'title="vector.toml"',title:'"vector.toml"'}),'[transforms.format_timestamp]\n  type = "coercer"\n  types.timestamp = "timestamp|%Y/%m/%d:%H:%M:%S %z"\n')),Object(i.b)("h2",{id:"working-with-data-formats"},"Working with data formats"),Object(i.b)("p",null,"Not all logs come structured. Some services provide JSON, some provide plaintext, others ship around protobufs. With\nVector you can handle them all."),Object(i.b)("p",null,"Generally Vector will be able to determine the encodings to use by the source or sink used. In some cases, multiple are\nsupported. In these cases, you can use the ",Object(i.b)("inlineCode",{parentName:"p"},"encoding")," option."),Object(i.b)("p",null,"The ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/reference/sinks/console/"}),Object(i.b)("inlineCode",{parentName:"a"},"console"))," sink supports both ",Object(i.b)("inlineCode",{parentName:"p"},"json")," and ",Object(i.b)("inlineCode",{parentName:"p"},"text")," as its\noutput format"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-toml",metastring:'title="vector.toml"',title:'"vector.toml"'}),'[sinks.print]\n  type = "console"\n  inputs = ["source0"]\n  target = "stdout"\n  encoding = "json"\n')),Object(i.b)("p",null,"You can also use a transform like ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/reference/transforms/json_parser/"}),Object(i.b)("inlineCode",{parentName:"a"},"json_parser"))," or\n",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/reference/transforms/grok_parser/"}),Object(i.b)("inlineCode",{parentName:"a"},"grok_parser"))," to parse out data in a given field."),Object(i.b)("h2",{id:"parting-thoughts"},"Parting thoughts"),Object(i.b)("p",null,"Exploring this article, we can see that Vector is able to consume multiple (even non-standard) formats of logs. We saw\nthat Vector can then reshape the data according to your needs. Then Vector can pass this data along."),Object(i.b)("p",null,"Let's consider some novel uses for Vector, given these tools! Vector can work as:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"A sanitization tool, ensuring malformed events never reach a service."),Object(i.b)("li",{parentName:"ul"},"A privacy tool, removing sensitive data before it leaves your infrastructure."),Object(i.b)("li",{parentName:"ul"},"A data corrector, adapting legacy systems to more modern systems which have evolved.")),Object(i.b)("p",null,"Where are you deploying Vector? Let us know, maybe we can help optimize it!"))}m.isMDXComponent=!0}}]);